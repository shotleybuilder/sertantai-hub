#!/bin/bash
# sertantai-hub Development Server Starter
# Starts hub backend (Phoenix) and frontend (SvelteKit) in terminal tabs
# Optionally manages Docker containers, sertantai-auth, and micro-services
#
# Usage:
#   sert-hub-start                          # Start hub servers only (assumes Docker + auth running)
#   sert-hub-start --docker                 # Start Docker containers + hub servers
#   sert-hub-start --auth                   # Also ensure sertantai-auth is running
#   sert-hub-start --docker --auth          # Thin test: hub + auth + containers
#   sert-hub-start --legal                  # Also start sertantai-legal
#   sert-hub-start --enforcement            # Also start sertantai-enforcement
#   sert-hub-start --thick                  # Thick test: hub + auth + all micro-services
#   sert-hub-start --docker --thick         # Full stack: containers + auth + all services
#
# Thin test = hub + auth + containers (minimum for hub development)
# Thick test = thin + legal + enforcement + controls (full micro-services stack)
#
# Symlink Setup (to run from anywhere):
#   sudo ln -s /home/jason/Desktop/sertantai-hub/scripts/development/sert-hub-start /usr/local/bin/sert-hub-start

set -e

# Help
show_help() {
    echo "sert-hub-start - Start sertantai-hub development servers"
    echo ""
    echo "Usage: sert-hub-start [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --docker        Start Docker containers (postgres + electric)"
    echo "  --auth          Also start sertantai-auth service (port 4000)"
    echo "  --legal         Also start sertantai-legal (ports 4003/5175)"
    echo "  --enforcement   Also start sertantai-enforcement (ports 4001/5174)"
    echo "  --thick         Start all services (auth + legal + enforcement)"
    echo "  -h, --help      Show this help message"
    echo ""
    echo "Common patterns:"
    echo "  sert-hub-start                    Hub only (assumes deps running)"
    echo "  sert-hub-start --docker --auth    Thin test (hub + auth + containers)"
    echo "  sert-hub-start --docker --thick   Thick test (full micro-services stack)"
    echo ""
    echo "Hub ports: backend 4006, frontend 5173, postgres 5435, electric 3000"
    exit 0
}

# Parse arguments
MANAGE_DOCKER=false
MANAGE_AUTH=false
MANAGE_LEGAL=false
MANAGE_ENFORCEMENT=false
THICK_MODE=false
for arg in "$@"; do
    case $arg in
        -h|--help)
            show_help
            ;;
        --docker)
            MANAGE_DOCKER=true
            ;;
        --auth)
            MANAGE_AUTH=true
            ;;
        --legal)
            MANAGE_LEGAL=true
            ;;
        --enforcement)
            MANAGE_ENFORCEMENT=true
            ;;
        --thick)
            THICK_MODE=true
            MANAGE_AUTH=true
            MANAGE_LEGAL=true
            MANAGE_ENFORCEMENT=true
            ;;
    esac
done

# Resolve symlink to get the actual script path
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
PROJECT_ROOT="$(cd "$(dirname "$SCRIPT_PATH")/../.." && pwd)"

# Port configuration
HUB_BACKEND_PORT=4006
HUB_FRONTEND_PORT=5173
HUB_DB_PORT=5435
HUB_ELECTRIC_PORT=3000

# Dependency service locations
AUTH_PROJECT_ROOT="$HOME/Desktop/sertantai-auth"
AUTH_PORT=4000

LEGAL_PROJECT_ROOT="$HOME/Desktop/sertantai-legal"
LEGAL_BACKEND_PORT=4003
LEGAL_FRONTEND_PORT=5175

ENFORCEMENT_PROJECT_ROOT="$HOME/Desktop/sertantai-enforcement"
ENFORCEMENT_BACKEND_PORT=4001
ENFORCEMENT_FRONTEND_PORT=5174

echo "Starting sertantai-hub development servers..."
echo "Project root: $PROJECT_ROOT"
if [ "$THICK_MODE" = true ]; then
    echo "Mode: THICK (full micro-services stack)"
else
    echo "Mode: thin (hub only)"
fi
echo ""

# Verify PROJECT_ROOT exists
if [ ! -d "$PROJECT_ROOT" ]; then
    echo "Error: Project root directory not found: $PROJECT_ROOT"
    exit 1
fi

if [ ! -f "$PROJECT_ROOT/backend/mix.exs" ]; then
    echo "Error: mix.exs not found in $PROJECT_ROOT/backend"
    exit 1
fi

# Check if hub servers are already running
if lsof -ti:$HUB_BACKEND_PORT >/dev/null 2>&1; then
    echo "Warning: Hub backend already running on port $HUB_BACKEND_PORT!"
    echo "   Stop it first with: sert-hub-stop"
    exit 1
fi

if lsof -ti:$HUB_FRONTEND_PORT >/dev/null 2>&1; then
    echo "Warning: Hub frontend already running on port $HUB_FRONTEND_PORT!"
    echo "   Stop it first with: sert-hub-stop"
    exit 1
fi

# ============================================================================
# sertantai-auth dependency management
# ============================================================================
check_auth_running() {
    curl -s -o /dev/null -w "%{http_code}" "http://localhost:$AUTH_PORT/health" 2>/dev/null | grep -q "200"
}

if [ "$MANAGE_AUTH" = true ]; then
    echo "Checking sertantai-auth service..."

    if [ ! -d "$AUTH_PROJECT_ROOT" ]; then
        echo "Error: sertantai-auth project not found at $AUTH_PROJECT_ROOT"
        exit 1
    fi

    if check_auth_running; then
        echo "   sertantai-auth already running on port $AUTH_PORT"
    else
        echo "   sertantai-auth not running, starting it..."

        # Check/start auth postgres container
        if ! docker ps --format '{{.Names}}' | grep -q "sertantai.*auth.*postgres"; then
            echo "   Starting sertantai-auth PostgreSQL..."
            cd "$AUTH_PROJECT_ROOT"
            docker compose -f docker-compose.dev.yml up -d postgres
            echo -n "   Waiting for auth postgres..."
            for i in $(seq 1 15); do
                if docker compose -f docker-compose.dev.yml exec -T postgres pg_isready -U postgres >/dev/null 2>&1; then
                    echo " ready"
                    break
                fi
                if [ "$i" -eq 15 ]; then
                    echo " timeout (may still be starting)"
                fi
                sleep 1
                echo -n "."
            done
            cd "$PROJECT_ROOT"
        else
            echo "   sertantai-auth PostgreSQL already running"
        fi

        # Start auth Phoenix server in a terminal tab
        echo "   Starting sertantai-auth Phoenix server (port $AUTH_PORT)..."
        gnome-terminal --tab --title="sertantai-auth-backend" --working-directory="$AUTH_PROJECT_ROOT" -- bash -c "echo 'Starting sertantai-auth on port $AUTH_PORT...'; echo 'Working directory: \$(pwd)'; echo ''; unset DATABASE_URL; mix phx.server; echo ''; echo 'Service stopped. Press Enter to close tab...'; read" &

        # Wait for auth to be healthy
        echo -n "   Waiting for sertantai-auth to be ready..."
        for i in $(seq 1 30); do
            if check_auth_running; then
                echo " ready"
                break
            fi
            if [ "$i" -eq 30 ]; then
                echo " timeout (may still be starting)"
            fi
            sleep 1
            echo -n "."
        done
    fi
    echo ""
else
    # Check if auth is running (informational)
    if check_auth_running; then
        echo "sertantai-auth: running on port $AUTH_PORT"
    else
        echo "Note: sertantai-auth not running (port $AUTH_PORT)"
        echo "   Tip: Use '--auth' flag to auto-start it"
    fi
    echo ""
fi

# ============================================================================
# Docker container management (sertantai-hub)
# ============================================================================
if [ "$MANAGE_DOCKER" = true ]; then
    echo "Managing Docker containers..."
    cd "$PROJECT_ROOT"

    NEED_START=false
    if ! docker ps --format '{{.Names}}' | grep -q "sertantai-hub.*postgres\|sertantai_hub.*postgres"; then
        NEED_START=true
    fi
    if ! docker ps --format '{{.Names}}' | grep -q "sertantai-hub.*electric\|sertantai_hub.*electric"; then
        NEED_START=true
    fi

    if [ "$NEED_START" = true ]; then
        echo "   Starting Docker services (postgres + electric)..."
        docker compose -f docker-compose.dev.yml up -d postgres
        echo -n "   Waiting for postgres..."
        for i in $(seq 1 15); do
            if docker compose -f docker-compose.dev.yml exec -T postgres pg_isready -U postgres >/dev/null 2>&1; then
                echo " ready"
                break
            fi
            if [ "$i" -eq 15 ]; then
                echo " timeout (may still be starting)"
            fi
            sleep 1
            echo -n "."
        done
        docker compose -f docker-compose.dev.yml up -d --no-deps electric

        # Wait for Electric to be ready
        echo -n "   Waiting for ElectricSQL..."
        for i in $(seq 1 30); do
            if curl -s -o /dev/null -w "" http://localhost:$HUB_ELECTRIC_PORT/v1/health 2>/dev/null; then
                echo " ready"
                break
            fi
            if [ "$i" -eq 30 ]; then
                echo " timeout (may still be starting)"
            fi
            sleep 1
            echo -n "."
        done
    else
        echo "   Docker services already running"
    fi
    echo ""
else
    # Check if Docker services are running (warning only)
    MISSING=""
    if ! docker ps --format '{{.Names}}' | grep -q "sertantai-hub.*postgres\|sertantai_hub.*postgres"; then
        MISSING="postgres"
    fi
    if ! docker ps --format '{{.Names}}' | grep -q "sertantai-hub.*electric\|sertantai_hub.*electric"; then
        if [ -n "$MISSING" ]; then
            MISSING="$MISSING, electric"
        else
            MISSING="electric"
        fi
    fi
    if [ -n "$MISSING" ]; then
        echo "Warning: Docker containers not detected ($MISSING)"
        echo "   Tip: Use 'sert-hub-start --docker' to auto-start containers"
        echo ""
    fi
fi

# ============================================================================
# Micro-service management (thick testing)
# ============================================================================
start_micro_service() {
    local service_name="$1"
    local project_root="$2"
    local start_script="$3"
    local backend_port="$4"

    echo "Checking $service_name..."

    if [ ! -d "$project_root" ]; then
        echo "   Warning: $service_name project not found at $project_root (skipping)"
        return
    fi

    if lsof -ti:$backend_port >/dev/null 2>&1; then
        echo "   $service_name already running on port $backend_port"
        return
    fi

    if [ -x "$start_script" ]; then
        echo "   Starting $service_name via its own start script..."
        local start_args=""
        if [ "$MANAGE_DOCKER" = true ]; then
            start_args="--docker"
        fi
        "$start_script" $start_args &
        wait $!
    else
        echo "   Warning: Start script not found: $start_script (skipping)"
    fi
}

if [ "$MANAGE_LEGAL" = true ]; then
    start_micro_service "sertantai-legal" \
        "$LEGAL_PROJECT_ROOT" \
        "$LEGAL_PROJECT_ROOT/scripts/development/sert-legal-start" \
        "$LEGAL_BACKEND_PORT"
    echo ""
fi

if [ "$MANAGE_ENFORCEMENT" = true ]; then
    start_micro_service "sertantai-enforcement" \
        "$ENFORCEMENT_PROJECT_ROOT" \
        "$ENFORCEMENT_PROJECT_ROOT/scripts/development/sert-enf-start" \
        "$ENFORCEMENT_BACKEND_PORT"
    echo ""
fi

# ============================================================================
# Start sertantai-hub servers
# ============================================================================
echo "Opening terminal tabs for sertantai-hub..."

# Create a temporary launcher script
LAUNCHER_SCRIPT=$(mktemp)

cat > "$LAUNCHER_SCRIPT" << 'LAUNCHER_EOF'
#!/bin/bash

PROJECT_ROOT="__PROJECT_ROOT__"

# Open Phoenix backend tab
gnome-terminal --tab --title="sertantai-hub-backend" --working-directory="$PROJECT_ROOT/backend" -- bash -c 'echo "Starting sertantai-hub backend on port __HUB_BACKEND_PORT__..."; echo "Working directory: $(pwd)"; echo ""; unset DATABASE_URL; mix phx.server; echo ""; echo "Service stopped. Press Enter to close tab..."; read' &
sleep 0.3

# Open SvelteKit frontend tab
gnome-terminal --tab --title="sertantai-hub-frontend" --working-directory="$PROJECT_ROOT/frontend" -- bash -c 'echo "Starting sertantai-hub frontend on port __HUB_FRONTEND_PORT__..."; echo "Working directory: $(pwd)"; echo ""; npm run dev; echo ""; echo "Service stopped. Press Enter to close tab..."; read' &

wait
LAUNCHER_EOF

# Replace placeholders
sed -i "s|__PROJECT_ROOT__|$PROJECT_ROOT|g" "$LAUNCHER_SCRIPT"
sed -i "s|__HUB_BACKEND_PORT__|$HUB_BACKEND_PORT|g" "$LAUNCHER_SCRIPT"
sed -i "s|__HUB_FRONTEND_PORT__|$HUB_FRONTEND_PORT|g" "$LAUNCHER_SCRIPT"
chmod +x "$LAUNCHER_SCRIPT"

# Execute the launcher script in a new gnome-terminal window
gnome-terminal --window -- bash -c "$LAUNCHER_SCRIPT; rm -f $LAUNCHER_SCRIPT"

echo ""
echo "Development servers starting in terminal tabs!"
echo ""
echo "Hub URLs:"
echo "   Backend:  http://localhost:$HUB_BACKEND_PORT  (phoenix)"
echo "   Frontend: http://localhost:$HUB_FRONTEND_PORT  (svelte)"
echo "   Electric: http://localhost:$HUB_ELECTRIC_PORT  (sync)"
echo "   Database: localhost:$HUB_DB_PORT  (postgres)"
if [ "$MANAGE_AUTH" = true ] || check_auth_running 2>/dev/null; then
    echo "   Auth:     http://localhost:$AUTH_PORT  (sertantai-auth)"
fi
if [ "$MANAGE_LEGAL" = true ]; then
    echo ""
    echo "Legal URLs:"
    echo "   Backend:  http://localhost:$LEGAL_BACKEND_PORT  (phoenix)"
    echo "   Frontend: http://localhost:$LEGAL_FRONTEND_PORT  (svelte)"
fi
if [ "$MANAGE_ENFORCEMENT" = true ]; then
    echo ""
    echo "Enforcement URLs:"
    echo "   Backend:  http://localhost:$ENFORCEMENT_BACKEND_PORT  (phoenix)"
    echo "   Frontend: http://localhost:$ENFORCEMENT_FRONTEND_PORT  (svelte)"
fi
echo ""
echo "To stop: sert-hub-stop"
if [ "$THICK_MODE" = true ]; then
    echo "To stop all: sert-hub-stop --thick"
fi
echo ""
