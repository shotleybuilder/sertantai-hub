#!/bin/bash
# sertantai-hub Development Server Stopper
# Stops hub backend (Phoenix) and frontend (SvelteKit) servers
#
# Usage:
#   sert-hub-stop                   # Stop hub servers only (leave Docker running)
#   sert-hub-stop --docker          # Stop hub servers + Docker containers
#   sert-hub-stop --auth            # Also stop sertantai-auth server
#   sert-hub-stop --thick           # Stop hub + all micro-services
#   sert-hub-stop --docker --thick  # Stop everything including all Docker containers
#
# Symlink Setup (to run from anywhere):
#   sudo ln -s /home/jason/Desktop/sertantai-hub/scripts/development/sert-hub-stop /usr/local/bin/sert-hub-stop

set -e

# Help
show_help() {
    echo "sert-hub-stop - Stop sertantai-hub development servers"
    echo ""
    echo "Usage: sert-hub-stop [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --docker        Also stop Docker containers (preserves data)"
    echo "  --auth          Also stop sertantai-auth service"
    echo "  --legal         Also stop sertantai-legal"
    echo "  --enforcement   Also stop sertantai-enforcement"
    echo "  --thick         Stop all services (auth + legal + enforcement)"
    echo "  -h, --help      Show this help message"
    echo ""
    echo "Common patterns:"
    echo "  sert-hub-stop                     Hub only (Docker keeps running)"
    echo "  sert-hub-stop --docker --auth     Stop hub + auth + containers"
    echo "  sert-hub-stop --docker --thick    Stop everything"
    exit 0
}

# Parse arguments
MANAGE_DOCKER=false
MANAGE_AUTH=false
MANAGE_LEGAL=false
MANAGE_ENFORCEMENT=false
THICK_MODE=false
for arg in "$@"; do
    case $arg in
        -h|--help)
            show_help
            ;;
        --docker)
            MANAGE_DOCKER=true
            ;;
        --auth)
            MANAGE_AUTH=true
            ;;
        --legal)
            MANAGE_LEGAL=true
            ;;
        --enforcement)
            MANAGE_ENFORCEMENT=true
            ;;
        --thick)
            THICK_MODE=true
            MANAGE_AUTH=true
            MANAGE_LEGAL=true
            MANAGE_ENFORCEMENT=true
            ;;
    esac
done

# Resolve symlink to get the actual script path
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
PROJECT_ROOT="$(cd "$(dirname "$SCRIPT_PATH")/../.." && pwd)"

# Port configuration
HUB_BACKEND_PORT=4006
HUB_FRONTEND_PORT=5173

# Dependency service locations
AUTH_PROJECT_ROOT="$HOME/Desktop/sertantai-auth"
AUTH_PORT=4000

LEGAL_PROJECT_ROOT="$HOME/Desktop/sertantai-legal"
LEGAL_STOP_SCRIPT="$LEGAL_PROJECT_ROOT/scripts/development/sert-legal-stop"

ENFORCEMENT_PROJECT_ROOT="$HOME/Desktop/sertantai-enforcement"
ENFORCEMENT_STOP_SCRIPT="$ENFORCEMENT_PROJECT_ROOT/scripts/development/sert-enf-stop"

echo "Stopping sertantai-hub development servers..."

# ============================================================================
# Stop hub servers
# ============================================================================

# Kill Phoenix backend processes (port 4006)
if lsof -ti:$HUB_BACKEND_PORT >/dev/null 2>&1; then
    echo "Killing hub backend processes (port $HUB_BACKEND_PORT)..."
    lsof -ti:$HUB_BACKEND_PORT | xargs kill -9 2>/dev/null || true
    sleep 0.5
    echo "   Hub backend killed"
else
    echo "   No hub backend processes found (port $HUB_BACKEND_PORT not in use)"
fi

# Kill SvelteKit frontend processes (port 5173)
if lsof -ti:$HUB_FRONTEND_PORT >/dev/null 2>&1; then
    echo "Killing hub frontend processes (port $HUB_FRONTEND_PORT)..."
    lsof -ti:$HUB_FRONTEND_PORT | xargs kill -9 2>/dev/null || true
    sleep 0.5
    echo "   Hub frontend killed"
else
    echo "   No hub frontend processes found (port $HUB_FRONTEND_PORT not in use)"
fi

# Clean up any remaining Elixir BEAM processes for hub
if pgrep -f "beam.smp.*sertantai_hub" > /dev/null; then
    echo "Cleaning up remaining hub BEAM VM processes..."
    pkill -9 -f "beam.smp.*sertantai_hub" || true
    echo "   Hub BEAM processes cleaned up"
fi

# ============================================================================
# Stop Docker containers if requested
# ============================================================================
if [ "$MANAGE_DOCKER" = true ]; then
    echo ""
    echo "Stopping hub Docker containers..."
    cd "$PROJECT_ROOT"
    docker compose -f docker-compose.dev.yml stop
    echo "   Hub Docker containers stopped"
fi

# ============================================================================
# Stop sertantai-auth if requested
# ============================================================================
if [ "$MANAGE_AUTH" = true ]; then
    echo ""
    echo "Stopping sertantai-auth..."

    # Kill auth Phoenix processes (port 4000)
    if lsof -ti:$AUTH_PORT >/dev/null 2>&1; then
        echo "   Killing sertantai-auth processes (port $AUTH_PORT)..."
        lsof -ti:$AUTH_PORT | xargs kill -9 2>/dev/null || true
        sleep 0.5
        echo "   sertantai-auth processes killed"
    else
        echo "   sertantai-auth not running (port $AUTH_PORT not in use)"
    fi

    # Clean up auth BEAM processes
    if pgrep -f "beam.smp.*sertantai_auth" > /dev/null; then
        pkill -9 -f "beam.smp.*sertantai_auth" || true
        echo "   sertantai-auth BEAM processes cleaned up"
    fi

    # Stop auth Docker if --docker also specified
    if [ "$MANAGE_DOCKER" = true ] && [ -d "$AUTH_PROJECT_ROOT" ]; then
        echo "   Stopping sertantai-auth Docker containers..."
        cd "$AUTH_PROJECT_ROOT"
        docker compose -f docker-compose.dev.yml stop
        echo "   sertantai-auth Docker containers stopped"
    fi
fi

# ============================================================================
# Stop micro-services if requested
# ============================================================================
if [ "$MANAGE_LEGAL" = true ]; then
    echo ""
    echo "Stopping sertantai-legal..."
    if [ -x "$LEGAL_STOP_SCRIPT" ]; then
        local_args=""
        if [ "$MANAGE_DOCKER" = true ]; then
            local_args="--docker"
        fi
        "$LEGAL_STOP_SCRIPT" $local_args
    else
        echo "   Stop script not found, trying port-based kill..."
        if lsof -ti:4003 >/dev/null 2>&1; then
            lsof -ti:4003 | xargs kill -9 2>/dev/null || true
            echo "   Legal backend killed (port 4003)"
        fi
        if lsof -ti:5175 >/dev/null 2>&1; then
            lsof -ti:5175 | xargs kill -9 2>/dev/null || true
            echo "   Legal frontend killed (port 5175)"
        fi
        if pgrep -f "beam.smp.*sertantai_legal" > /dev/null; then
            pkill -9 -f "beam.smp.*sertantai_legal" || true
            echo "   Legal BEAM processes cleaned up"
        fi
    fi
fi

if [ "$MANAGE_ENFORCEMENT" = true ]; then
    echo ""
    echo "Stopping sertantai-enforcement..."
    if [ -x "$ENFORCEMENT_STOP_SCRIPT" ]; then
        local_args=""
        if [ "$MANAGE_DOCKER" = true ]; then
            local_args="--docker"
        fi
        "$ENFORCEMENT_STOP_SCRIPT" $local_args
    else
        echo "   Stop script not found, trying port-based kill..."
        if lsof -ti:4001 >/dev/null 2>&1; then
            lsof -ti:4001 | xargs kill -9 2>/dev/null || true
            echo "   Enforcement backend killed (port 4001)"
        fi
        if lsof -ti:5174 >/dev/null 2>&1; then
            lsof -ti:5174 | xargs kill -9 2>/dev/null || true
            echo "   Enforcement frontend killed (port 5174)"
        fi
        if pgrep -f "beam.smp.*sertantai_enforcement" > /dev/null; then
            pkill -9 -f "beam.smp.*sertantai_enforcement" || true
            echo "   Enforcement BEAM processes cleaned up"
        fi
    fi
fi

# ============================================================================
# Summary
# ============================================================================
echo ""
echo "All requested servers stopped!"
echo ""
if [ "$MANAGE_DOCKER" = true ]; then
    echo "To start again: sert-hub-start --docker"
else
    echo "To start again: sert-hub-start"
    echo "Tip: Docker containers are still running. Use 'sert-hub-stop --docker' to stop them."
fi
if [ "$THICK_MODE" = true ]; then
    echo "Tip: Micro-services were also stopped. Use '--thick' with start to restart them."
fi
echo ""
