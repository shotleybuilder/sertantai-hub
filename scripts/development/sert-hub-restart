#!/bin/bash
# sertantai-hub Development Server Restarter
# Forcefully stops and restarts hub backend (Phoenix) and frontend (SvelteKit) servers
#
# Usage:
#   sert-hub-restart                # Restart all hub servers
#   sert-hub-restart --frontend     # Restart only frontend (port 5173)
#   sert-hub-restart --backend      # Restart only backend (port 4006)
#   sert-hub-restart --docker       # Restart servers + Docker containers
#   sert-hub-restart --auth         # Also manage sertantai-auth service
#   sert-hub-restart --thick        # Restart hub + all micro-services
#   sert-hub-restart --force        # Force kill immediately (skip graceful shutdown)
#
# Symlink Setup (to run from anywhere):
#   sudo ln -s /home/jason/Desktop/sertantai-hub/scripts/development/sert-hub-restart /usr/local/bin/sert-hub-restart

set -e

# Help
show_help() {
    echo "sert-hub-restart - Restart sertantai-hub development servers"
    echo ""
    echo "Usage: sert-hub-restart [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --frontend      Restart only frontend (port 5173)"
    echo "  --backend       Restart only backend (port 4006)"
    echo "  --docker        Also restart Docker containers (preserves data)"
    echo "  --auth          Also manage sertantai-auth service"
    echo "  --thick         Restart hub + auth"
    echo "  --force         Force kill immediately (skip graceful shutdown)"
    echo "  -h, --help      Show this help message"
    echo ""
    echo "Common patterns:"
    echo "  sert-hub-restart                  Restart all hub servers"
    echo "  sert-hub-restart --frontend       Restart frontend only"
    echo "  sert-hub-restart --backend        Restart backend only"
    echo "  sert-hub-restart --force          Force kill then restart"
    echo "  sert-hub-restart --docker --auth  Restart everything"
    exit 0
}

# Parse arguments
MANAGE_DOCKER=false
MANAGE_AUTH=false
FORCE_KILL=false
FRONTEND_ONLY=false
BACKEND_ONLY=false
THICK_MODE=false
for arg in "$@"; do
    case $arg in
        -h|--help)
            show_help
            ;;
        --docker)
            MANAGE_DOCKER=true
            ;;
        --auth)
            MANAGE_AUTH=true
            ;;
        --force)
            FORCE_KILL=true
            ;;
        --frontend)
            FRONTEND_ONLY=true
            ;;
        --backend)
            BACKEND_ONLY=true
            ;;
        --thick)
            THICK_MODE=true
            MANAGE_AUTH=true
            ;;
    esac
done

# Resolve symlink to get the actual script path
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
PROJECT_ROOT="$(cd "$(dirname "$SCRIPT_PATH")/../.." && pwd)"

# Port configuration
HUB_BACKEND_PORT=4006
HUB_FRONTEND_PORT=5173
HUB_ELECTRIC_PORT=3000

# Dependency service locations
AUTH_PROJECT_ROOT="$HOME/Desktop/sertantai-auth"
AUTH_PORT=4000

if [ "$FRONTEND_ONLY" = true ]; then
    echo "Restarting hub frontend only..."
elif [ "$BACKEND_ONLY" = true ]; then
    echo "Restarting hub backend only..."
else
    echo "Restarting sertantai-hub development servers..."
fi
echo ""

# ============================================================================
# Helper functions
# ============================================================================
kill_process_safely() {
    local process_pattern="$1"
    local process_name="$2"
    local max_wait=5

    if pgrep -f "$process_pattern" > /dev/null; then
        echo "Stopping $process_name..."

        if [ "$FORCE_KILL" = true ]; then
            pkill -9 -f "$process_pattern" || true
            echo "   $process_name force-killed"
        else
            # Try graceful shutdown first (SIGTERM)
            pkill -f "$process_pattern" || true

            # Wait up to max_wait seconds for graceful shutdown
            local waited=0
            while pgrep -f "$process_pattern" > /dev/null && [ $waited -lt $max_wait ]; do
                sleep 1
                waited=$((waited + 1))
                echo -n "."
            done
            echo ""

            # If still running, force kill (SIGKILL)
            if pgrep -f "$process_pattern" > /dev/null; then
                echo "   Graceful shutdown timed out, force killing..."
                pkill -9 -f "$process_pattern" || true
                sleep 1
            fi

            echo "   $process_name stopped"
        fi
    else
        echo "   $process_name not running"
    fi
}

wait_for_port_free() {
    local port="$1"
    local max_wait=10
    local waited=0

    while lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1 && [ $waited -lt $max_wait ]; do
        if [ $waited -eq 0 ]; then
            echo "Waiting for port $port to be freed..."
        fi
        sleep 1
        waited=$((waited + 1))
        echo -n "."
    done

    if [ $waited -gt 0 ]; then
        echo ""
    fi

    if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1; then
        echo "   Port $port still in use after ${max_wait}s"
        echo "   Killing process on port $port..."
        lsof -ti:$port | xargs kill -9 2>/dev/null || true
        sleep 1
    fi
}

check_auth_running() {
    curl -s -o /dev/null -w "%{http_code}" "http://localhost:$AUTH_PORT/health" 2>/dev/null | grep -q "200"
}

# ============================================================================
# Step 1: Stop existing processes
# ============================================================================
echo "Step 1: Stopping existing processes"
echo "------------------------------------"

if [ "$FRONTEND_ONLY" = false ]; then
    # Kill hub backend by port
    if lsof -ti:$HUB_BACKEND_PORT >/dev/null 2>&1; then
        echo "Killing hub backend (port $HUB_BACKEND_PORT)..."
        lsof -ti:$HUB_BACKEND_PORT | xargs kill -9 2>/dev/null || true
        sleep 0.5
        echo "   Hub backend killed"
    else
        echo "   Hub backend not running"
    fi

    # Kill Elixir BEAM processes for hub
    if pgrep -f "beam.smp.*sertantai_hub" > /dev/null; then
        echo "Stopping hub BEAM VM processes..."
        pkill -9 -f "beam.smp.*sertantai_hub" || true
        echo "   Hub BEAM processes stopped"
    fi
fi

if [ "$BACKEND_ONLY" = false ]; then
    # Kill hub frontend by port
    if lsof -ti:$HUB_FRONTEND_PORT >/dev/null 2>&1; then
        echo "Killing hub frontend (port $HUB_FRONTEND_PORT)..."
        lsof -ti:$HUB_FRONTEND_PORT | xargs kill -9 2>/dev/null || true
        sleep 0.5
        echo "   Hub frontend killed"
    else
        echo "   Hub frontend not running"
    fi
fi

echo ""

# ============================================================================
# Step 2: Ensure ports are available
# ============================================================================
echo "Step 2: Ensuring ports are available"
echo "-------------------------------------"

if [ "$FRONTEND_ONLY" = false ]; then
    wait_for_port_free $HUB_BACKEND_PORT
fi

if [ "$BACKEND_ONLY" = false ]; then
    wait_for_port_free $HUB_FRONTEND_PORT
fi

if [ "$FRONTEND_ONLY" = true ]; then
    echo "   Port $HUB_FRONTEND_PORT is free"
elif [ "$BACKEND_ONLY" = true ]; then
    echo "   Port $HUB_BACKEND_PORT is free"
else
    echo "   Ports $HUB_BACKEND_PORT and $HUB_FRONTEND_PORT are free"
fi
echo ""

# ============================================================================
# Handle Docker if requested
# ============================================================================
if [ "$MANAGE_DOCKER" = true ]; then
    echo "Managing Docker containers..."
    cd "$PROJECT_ROOT"

    docker compose -f docker-compose.dev.yml stop
    echo "   Starting Docker services (postgres)..."
    docker compose -f docker-compose.dev.yml up -d postgres

    echo -n "   Waiting for postgres..."
    for i in $(seq 1 15); do
        if docker compose -f docker-compose.dev.yml exec -T postgres pg_isready -U postgres >/dev/null 2>&1; then
            echo " ready"
            break
        fi
        if [ "$i" -eq 15 ]; then
            echo " timeout (may still be starting)"
        fi
        sleep 1
        echo -n "."
    done

    docker compose -f docker-compose.dev.yml up -d --no-deps electric

    echo -n "   Waiting for ElectricSQL..."
    for i in $(seq 1 30); do
        if curl -s -o /dev/null -w "" http://localhost:$HUB_ELECTRIC_PORT/v1/health 2>/dev/null; then
            echo " ready"
            break
        fi
        if [ "$i" -eq 30 ]; then
            echo " timeout (may still be starting)"
        fi
        sleep 1
        echo -n "."
    done
    echo ""
fi

# ============================================================================
# Handle sertantai-auth if requested
# ============================================================================
if [ "$MANAGE_AUTH" = true ]; then
    echo "Checking sertantai-auth service..."

    if [ ! -d "$AUTH_PROJECT_ROOT" ]; then
        echo "   Warning: sertantai-auth project not found at $AUTH_PROJECT_ROOT"
    elif check_auth_running; then
        echo "   sertantai-auth already running on port $AUTH_PORT"
    else
        echo "   sertantai-auth not running, starting it..."

        # Check/start auth postgres container
        if ! docker ps --format '{{.Names}}' | grep -q "sertantai.*auth.*postgres"; then
            echo "   Starting sertantai-auth PostgreSQL..."
            cd "$AUTH_PROJECT_ROOT"
            docker compose -f docker-compose.dev.yml up -d postgres
            sleep 3
            cd "$PROJECT_ROOT"
        fi

        # Start auth Phoenix server
        gnome-terminal --tab --title="sertantai-auth-backend" --working-directory="$AUTH_PROJECT_ROOT" -- bash -c "echo 'Starting sertantai-auth on port $AUTH_PORT...'; echo 'Working directory: \$(pwd)'; echo ''; unset DATABASE_URL; mix phx.server; echo ''; echo 'Service stopped. Press Enter to close tab...'; read" &

        echo -n "   Waiting for sertantai-auth..."
        for i in $(seq 1 30); do
            if check_auth_running; then
                echo " ready"
                break
            fi
            if [ "$i" -eq 30 ]; then
                echo " timeout (may still be starting)"
            fi
            sleep 1
            echo -n "."
        done
    fi
    echo ""
fi

# ============================================================================
# Step 3: Start hub servers
# ============================================================================
echo "Step 3: Starting development servers"
echo "-------------------------------------"

# Verify project structure
if [ ! -d "$PROJECT_ROOT" ] || [ ! -f "$PROJECT_ROOT/backend/mix.exs" ]; then
    echo "Error: Project root or mix.exs not found"
    exit 1
fi

# Check Docker if not managing it
if [ "$MANAGE_DOCKER" = false ] && [ "$FRONTEND_ONLY" = false ]; then
    if ! docker ps --format '{{.Names}}' | grep -q "sertantai-hub.*postgres\|sertantai_hub.*postgres"; then
        echo "Warning: Docker containers not detected"
        echo "   Tip: Use 'sert-hub-restart --docker' to restart with Docker"
        echo ""
    fi
fi

echo "Opening terminal tabs..."

# Create a temporary launcher script
LAUNCHER_SCRIPT=$(mktemp)

if [ "$FRONTEND_ONLY" = true ]; then
    cat > "$LAUNCHER_SCRIPT" << 'LAUNCHER_EOF'
#!/bin/bash
PROJECT_ROOT="__PROJECT_ROOT__"
gnome-terminal --tab --title="sertantai-hub-frontend" --working-directory="$PROJECT_ROOT/frontend" -- bash -c 'echo "Starting sertantai-hub frontend on port __HUB_FRONTEND_PORT__..."; echo "Working directory: $(pwd)"; echo ""; npm run dev; echo ""; echo "Service stopped. Press Enter to close tab..."; read' &
wait
LAUNCHER_EOF
elif [ "$BACKEND_ONLY" = true ]; then
    cat > "$LAUNCHER_SCRIPT" << 'LAUNCHER_EOF'
#!/bin/bash
PROJECT_ROOT="__PROJECT_ROOT__"
gnome-terminal --tab --title="sertantai-hub-backend" --working-directory="$PROJECT_ROOT/backend" -- bash -c 'echo "Starting sertantai-hub backend on port __HUB_BACKEND_PORT__..."; echo "Working directory: $(pwd)"; echo ""; unset DATABASE_URL; mix phx.server; echo ""; echo "Service stopped. Press Enter to close tab..."; read' &
wait
LAUNCHER_EOF
else
    cat > "$LAUNCHER_SCRIPT" << 'LAUNCHER_EOF'
#!/bin/bash
PROJECT_ROOT="__PROJECT_ROOT__"
gnome-terminal --tab --title="sertantai-hub-backend" --working-directory="$PROJECT_ROOT/backend" -- bash -c 'echo "Starting sertantai-hub backend on port __HUB_BACKEND_PORT__..."; echo "Working directory: $(pwd)"; echo ""; unset DATABASE_URL; mix phx.server; echo ""; echo "Service stopped. Press Enter to close tab..."; read' &
sleep 0.3
gnome-terminal --tab --title="sertantai-hub-frontend" --working-directory="$PROJECT_ROOT/frontend" -- bash -c 'echo "Starting sertantai-hub frontend on port __HUB_FRONTEND_PORT__..."; echo "Working directory: $(pwd)"; echo ""; npm run dev; echo ""; echo "Service stopped. Press Enter to close tab..."; read' &
wait
LAUNCHER_EOF
fi

# Replace placeholders
sed -i "s|__PROJECT_ROOT__|$PROJECT_ROOT|g" "$LAUNCHER_SCRIPT"
sed -i "s|__HUB_BACKEND_PORT__|$HUB_BACKEND_PORT|g" "$LAUNCHER_SCRIPT"
sed -i "s|__HUB_FRONTEND_PORT__|$HUB_FRONTEND_PORT|g" "$LAUNCHER_SCRIPT"
chmod +x "$LAUNCHER_SCRIPT"

# Execute the launcher script in a new gnome-terminal window
gnome-terminal --window -- bash -c "$LAUNCHER_SCRIPT; rm -f $LAUNCHER_SCRIPT"

echo ""
if [ "$FRONTEND_ONLY" = true ]; then
    echo "Hub frontend restarted!"
    echo ""
    echo "URL:"
    echo "   Frontend: http://localhost:$HUB_FRONTEND_PORT  (svelte)"
elif [ "$BACKEND_ONLY" = true ]; then
    echo "Hub backend restarted!"
    echo ""
    echo "URL:"
    echo "   Backend:  http://localhost:$HUB_BACKEND_PORT  (phoenix)"
else
    echo "Hub development servers restarted!"
    echo ""
    echo "URLs:"
    echo "   Backend:  http://localhost:$HUB_BACKEND_PORT  (phoenix)"
    echo "   Frontend: http://localhost:$HUB_FRONTEND_PORT  (svelte)"
    echo "   Electric: http://localhost:$HUB_ELECTRIC_PORT  (sync)"
    if [ "$MANAGE_AUTH" = true ] || check_auth_running 2>/dev/null; then
        echo "   Auth:     http://localhost:$AUTH_PORT  (sertantai-auth)"
    fi
fi
echo ""
echo "Tips:"
echo "   Stop servers:      sert-hub-stop"
echo "   Restart all:       sert-hub-restart"
echo "   Restart frontend:  sert-hub-restart --frontend"
echo "   Restart backend:   sert-hub-restart --backend"
echo "   Force restart:     sert-hub-restart --force"
echo "   With auth:         sert-hub-restart --auth"
if [ "$MANAGE_DOCKER" = true ]; then
    echo "   (Docker was restarted)"
else
    echo "   (Docker was not restarted - use --docker flag)"
fi
echo ""
