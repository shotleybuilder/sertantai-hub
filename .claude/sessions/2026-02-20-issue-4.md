# Issue #4: Debug registration workflow when deployed to production

**Started**: 2026-02-20
**Ended**: 2026-02-20
**Status**: RESOLVED
**Issue**: https://github.com/shotleybuilder/sertantai-hub/issues/4
**Commit**: 8bb6234

## Root Cause

Frontend gets "NetworkError when attempting to fetch resource" — request never reaches backend (no logs on hub or auth).

Three configuration issues found:

1. **`frontend/.env.production`** — `VITE_API_URL` is still the template placeholder (`https://app.yourdomain.com/api`), so fetch goes to a nonexistent domain
2. **`backend/lib/sertantai_hub_web/endpoint.ex`** — CORS `System.get_env("FRONTEND_URL")` evaluated at compile time, baked into release as `""`
3. **`backend/lib/sertantai_hub_web/controllers/auth_proxy_controller.ex`** — `@auth_url` uses `Application.compile_env`, so `AUTH_SERVICE_URL` baked in at build time as `http://localhost:4000`

## Todo
- [x] Investigate registration workflow in production
- [x] Identify root cause
- [x] Fix `frontend/.env.production` — set `VITE_API_URL=https://sertantai.com`
- [x] Fix CORS in `endpoint.ex` — move `FRONTEND_URL` to runtime config via `{mod, fun, args}` callback
- [x] Add `FRONTEND_URL` and `AUTH_SERVICE_URL` to infrastructure `docker-compose.yml` (live on server)
- [x] Fix `auth_proxy_controller.ex` — read `auth_service_url` at runtime instead of compile time
- [x] Rebuild and deploy backend + frontend
- [x] Verify registration works in production

## Key Files
- `frontend/.env.production`
- `backend/lib/sertantai_hub_web/endpoint.ex:55-75` — Corsica plug + cors_origins/2 callback
- `backend/lib/sertantai_hub_web/controllers/auth_proxy_controller.ex:4` — auth_url/0
- `backend/config/runtime.exs` — :cors_origins + :auth_service_url runtime config

## Notes
- Auth service healthy at https://auth.sertantai.com/health
- Production site: https://sertantai.com (hub.sertantai.com redirects)
- Symptom: no logs on either service because request never leaves the browser
- Infrastructure docker-compose.yml updated with `FRONTEND_URL=https://sertantai.com` and `AUTH_SERVICE_URL=https://auth.sertantai.com`
